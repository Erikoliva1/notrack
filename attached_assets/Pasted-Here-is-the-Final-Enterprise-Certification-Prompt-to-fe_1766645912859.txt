Here is the **Final "Enterprise Certification" Prompt** to feed into your Replit AI Agent.

This prompt is engineered to instruct the AI to perform a "Level 5 Audit" (the highest level) and implement the complex logic changes for **Persistent IDs**, **Forced Permissions**, and the **Audio Kill Switch**.

**Copy and paste this directly into Replit:**

---

> "Act as a Senior Full-Stack Architect and Security Lead. We are executing the **Phase 6: Final Production Polish & Logic Upgrade** for the 'NoTrack' WebRTC application.
> **Goal:** Transform the codebase into a bug-free, enterprise-grade release candidate. Fix specific user experience issues regarding identity persistence and audio artifacts.
> **CRITICAL TASK LIST:**
> **1. Implement Persistent Identity (Sticky Extensions):**
> * **Client (`client/src/hooks/useSignalProtocol.ts`):** Modify the socket connection logic. Before connecting, check `localStorage` for a key named `notrack_extension`. Pass this value in the socket handshake `auth` object. On the `extension-assigned` event, save the assigned ID back to `localStorage`.
> * **Server (`app/server/src/socket.ts`):** Update the `connection` handler. Read the `socket.handshake.auth.extension`. If the client sends a valid ID (Regex `^\d{3}-\d{3}$`), assign that specific ID instead of generating a random one.
> 
> 
> **2. Force "Aggressive" Permissions:**
> * **Client (`client/src/pages/SecureTerminal.tsx`):** Add a `useEffect` on component mount that triggers `navigator.mediaDevices.getUserMedia({ audio: true })` immediately. Once access is granted, stop the tracks to release the mic, but keep the permission state active. This ensures the browser is ready *before* a call starts.
> 
> 
> **3. Fix Audio Artifacts (The 'Stuck Beep' Bug):**
> * **Client (`client/src/pages/SecureTerminal.tsx`):** Implement a strict `stopAllAudio()` helper function. This function must `pause()` and reset (`currentTime = 0`) the `ringtoneRef`.
> * **Trigger Points:** Call `stopAllAudio()` immediately inside `handleHangup()`, `handleAnswer()`, and `handleCallEnd()`. Ensure no audio loop persists after the connection changes state.
> 
> 
> **4. Enterprise Clean-Up:**
> * Scan `App.tsx` and ensure the routing logic includes the '404 Trap' (Catch-all route).
> * Remove all 'debug' level console logs (`console.log`), but keep `console.error` for critical failures.
> * Verify that `sanitize.ts` on the server allows newlines (`\n`, `\r`) to prevent SDP parsing errors.
> 
> 
> **Output:**
> Modify the necessary files directly. Do not break existing WebRTC signaling logic. Provide a summary of files changed and confirmed fixes."

---

### **What this does:**

1. **Fixes the Number Change:** It forces your code to "remember" the user's number so they don't get a new one every time they refresh.
2. **Fixes the "Unable to Accept":** By forcing permission *at the start*, the browser won't block the "Answer" click for security reasons.
3. **Fixes the Beep:** It explicitly orders the code to kill the ringtone sound whenever the call state changes.